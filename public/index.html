<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>aiPRINT.ai — Turn any idea into a gallery-worthy print</title>
  <meta name="description" content="Create premium, ready-to-hang fine art prints from your idea. AI + human curation, archival materials, Certificate of Authenticity." />
  <link rel="icon" href="/favicon.ico" />

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root { --bg:#0a0f1d; --ink:#e7eef8; --muted:#9fb3c8; }
    html,body{background:var(--bg);color:var(--ink);}
    body{font-family:ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;}
    .h1{font-size:clamp(2.2rem,4vw,3.4rem);font-weight:800;line-height:1.05}
    .h2{font-size:clamp(1.4rem,2.4vw,2.1rem);font-weight:800;}
    .muted{color:var(--muted)}
    .glass{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);backdrop-filter:blur(6px)}
    .btn{background:#fff;color:#000;font-weight:700;padding:.7rem 1rem;border-radius:.6rem;cursor:pointer;border:none;}
    .btn-ghost{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.14);color:#e7eef8;cursor:pointer;padding:.7rem 1rem;border-radius:.6rem;}
    .btn:disabled,.btn.disabled{opacity:0.5;cursor:not-allowed;filter:saturate(0.5);}
    .ringy{box-shadow:0 0 0 2px #fff inset}
    .spinner{border:2px solid #333;border-top:2px solid #fff;border-radius:50%;width:20px;height:20px;animation:spin 1s linear infinite;}
    @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
    .material-badge{display:inline-block;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:600;margin-right:4px;}
    .material-canvas{background:#8B4513;color:white;}
    .material-metal{background:#708090;color:white;}
    .material-acrylic{background:#4169E1;color:white;}
    
    /* Visual improvements */
    .sizeBtn:hover:not(.disabled) {
      transform: translateX(2px);
      box-shadow: 0 0 0 1px rgba(255,255,255,0.3);
    }
    .sizeBtn.ringy {
      background: rgba(255,255,255,0.15);
      border-color: white;
    }
    
    /* Dropdown styling */
    .dropdown-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--muted);
      margin-bottom: 6px;
      display: block;
    }
    
    select {
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23ffffff' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
      background-position: right 0.5rem center;
      background-repeat: no-repeat;
      background-size: 1.5em 1.5em;
      padding-right: 2.5rem;
    }
    
    /* Preview container styling */
    .preview-container {
      background: #1a1f2e;
      background-image: 
        repeating-linear-gradient(45deg, transparent, transparent 35px, rgba(255,255,255,.02) 35px, rgba(255,255,255,.02) 70px),
        repeating-linear-gradient(-45deg, transparent, transparent 35px, rgba(255,255,255,.02) 35px, rgba(255,255,255,.02) 70px);
    }
    
    /* Watermark styles */
    .watermark-overlay {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) rotate(-45deg);
      font-size: 5rem;
      font-weight: 900;
      color: rgba(255, 255, 255, 0.15);
      text-transform: uppercase;
      letter-spacing: 1rem;
      pointer-events: none;
      text-shadow: 0 0 20px rgba(0,0,0,0.5);
      z-index: 5;
      user-select: none;
    }
    
    /* Signature styles */
    .signature-controls {
      background: rgba(0,0,0,0.8);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 8px;
      padding: 12px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }
    
    .signature-control-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .signature-control-group label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: rgba(255,255,255,0.6);
    }
    
    .moveable-signature {
      position: absolute;
      cursor: move;
      user-select: none;
      text-shadow: 0 0 10px rgba(0,0,0,0.8);
      transition: opacity 0.3s;
      z-index: 10;
    }
    
    .moveable-signature:hover {
      opacity: 0.8;
    }
    
    /* Font families for signature */
    .font-elegant { font-family: 'Georgia', serif; }
    .font-script { font-family: 'Brush Script MT', cursive; }
    .font-modern { font-family: 'Arial', sans-serif; }
    .font-classic { font-family: 'Times New Roman', serif; }
    .font-bold { font-family: 'Impact', sans-serif; }
    
    /* Share modal styles */
    .share-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #1a1f2e;
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 12px;
      padding: 24px;
      z-index: 100;
      max-width: 500px;
      width: 90%;
    }
    
    .share-modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      z-index: 99;
    }
  </style>
</head>
<body>

  <!-- HEADER -->
  <header class="sticky top-0 z-50 bg-[#0b1020]/85 backdrop-blur border-b border-white/10">
    <div class="max-w-7xl mx-auto px-5 h-16 flex items-center justify-between">
      <a href="/" class="flex items-center gap-2">
        <span class="w-7 h-7 rounded-lg bg-white text-black font-black grid place-items-center">AI</span>
        <span class="font-extrabold tracking-tight">aiPRINT.<span class="text-sky-300">ai</span></span>
      </a>
      <nav class="hidden md:flex items-center gap-6 text-base">
        <a href="#how" class="hover:text-white">How it works</a>
        <a href="#materials" class="hover:text-white">Materials</a>
        <a href="/faq.html" class="hover:text-white">FAQ</a>
        <a href="/policies.html" class="hover:text-white">Policies</a>
        <a href="/contact.html" class="hover:text-white">Contact</a>
      </nav>
    </div>
  </header>

  <!-- HERO -->
  <section class="max-w-7xl mx-auto px-5 pt-6 pb-12 grid lg:grid-cols-2 gap-10 items-center">
    <div>
      <h1 class="h1">Turn any idea into a <span class="text-indigo-300">gallery-worthy</span> print.</h1>
      <p class="muted mt-4 max-w-xl">Type a prompt. We create the art with AI + a human artist's eye. You pick size & finish. We ship an archival, limited-edition print to your door.</p>
      <div class="flex gap-3 mt-6">
        <a href="#create" class="btn">Create a preview</a>
        <a href="#how" class="btn-ghost">See how it works</a>
      </div>
      <p class="mt-5 text-sm text-gray-400">Made in the USA · Archival materials · Certificate of Authenticity · Ready to hang</p>
    </div>
    <div class="grid gap-4">
      <div class="h-64 rounded-2xl overflow-hidden glass">
        <img src="https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?q=80&w=1600&auto=format&fit=crop" class="w-full h-full object-cover" alt="">
      </div>
      <div class="grid grid-cols-2 gap-4">
        <div class="h-36 rounded-2xl overflow-hidden glass">
          <img src="https://images.unsplash.com/photo-1501785888041-af3ef285b470?q=80&w=1200&auto=format&fit=crop" class="w-full h-full object-cover" alt="">
        </div>
        <div class="h-36 rounded-2xl overflow-hidden glass">
          <img src="https://images.unsplash.com/photo-1507525428034-b723cf961d3e?q=80&w=1200&auto=format&fit=crop" class="w-full h-full object-cover" alt="">
        </div>
      </div>
    </div>
  </section>

  <!-- HOW -->
  <section id="how" class="max-w-7xl mx-auto px-5 py-12">
    <h2 class="h2 mb-6">How it works</h2>
    <div class="grid md:grid-cols-3 gap-5">
      <div class="glass rounded-xl p-5">
        <div class="font-bold text-xs tracking-widest text-white/60">STEP 1</div>
        <div class="mt-2 font-extrabold">Describe your idea</div>
        <p class="muted">Share a prompt (style, mood, colors). Add an optional reference image.</p>
      </div>
      <div class="glass rounded-xl p-5">
        <div class="font-bold text-xs tracking-widest text-white/60">STEP 2</div>
        <div class="mt-2 font-extrabold">We craft your artwork</div>
        <p class="muted">Your prompt generates a preview with our human curation.</p>
      </div>
      <div class="glass rounded-xl p-5">
        <div class="font-bold text-xs tracking-widest text-white/60">STEP 3</div>
        <div class="mt-2 font-extrabold">Printed. Signed. Shipped.</div>
        <p class="muted">Premium materials, ready to hang. Certificate of Authenticity.</p>
      </div>
    </div>
  </section>

  <!-- Materials Preview -->
  <section id="materials" class="max-w-7xl mx-auto px-5 py-12">
    <h2 class="h2 mb-6">Materials & finishes</h2>
    <div class="grid md:grid-cols-3 gap-5">
      <div class="glass rounded-xl p-5">
        <div class="text-lg font-extrabold">Signature Series – Fine Art Canvas</div>
        <p class="muted mt-2">Archival fine-art canvas with rich texture and deep color, gallery-wrapped and ready to hang.</p>
      </div>
      <div class="glass rounded-xl p-5">
        <div class="text-lg font-extrabold">Gallery Edition – ChromaLuxe Metal</div>
        <p class="muted mt-2">Vibrant aluminum print with durable float mount. Sleek modern look, ready to hang.</p>
      </div>
      <div class="glass rounded-xl p-5">
        <div class="text-lg font-extrabold">Museum Collection – Acrylic Facemount</div>
        <p class="muted mt-2">Museum-grade acrylic facemount with brilliant clarity and depth, polished edges, ready to hang.</p>
      </div>
    </div>
  </section>

  <!-- CREATE -->
  <section id="create" class="max-w-7xl mx-auto px-5 py-14">
    <h2 class="h2 mb-4">Create a preview</h2>
    <div class="glass rounded-xl p-5 md:p-6">
      <!-- Prompt input -->
      <div class="mb-6">
        <label class="text-sm muted block mb-2">Describe your artwork</label>
        <textarea id="promptInput" class="w-full rounded-lg bg-white/10 border border-white/15 px-3 py-3 min-h-[80px] text-white resize-none" 
                  placeholder="e.g., photographer on jeep in mountains, golden hour lighting"></textarea>
      </div>

      <!-- Style dropdowns grid -->
      <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 mb-6">
        <!-- Style -->
        <div>
          <label class="dropdown-label">Style</label>
          <select id="styleSelect" class="w-full rounded-lg bg-white/10 border border-white/15 px-3 py-2 text-white text-sm">
            <option value="Realistic (photo-realistic)" selected>Realistic (photo-realistic)</option>
            <option value="Hyper-realistic">Hyper-realistic</option>
            <option value="Painterly">Painterly</option>
            <option value="Abstract">Abstract</option>
            <option value="Impressionistic">Impressionistic</option>
            <option value="Minimalist">Minimalist</option>
            <option value="Surreal">Surreal</option>
            <option value="Conceptual / Artistic">Conceptual / Artistic</option>
            <option value="Sketch / Illustration">Sketch / Illustration</option>
            <option value="3D Render / CGI">3D Render / CGI</option>
          </select>
        </div>

        <!-- Mood -->
        <div>
          <label class="dropdown-label">Mood / Atmosphere</label>
          <select id="moodSelect" class="w-full rounded-lg bg-white/10 border border-white/15 px-3 py-2 text-white text-sm">
            <option value="">Select mood...</option>
            <option value="Calm / Peaceful">Calm / Peaceful</option>
            <option value="Dramatic / Intense">Dramatic / Intense</option>
            <option value="Moody / Atmospheric">Moody / Atmospheric</option>
            <option value="Bright / Uplifting">Bright / Uplifting</option>
            <option value="Mysterious">Mysterious</option>
            <option value="Energetic / Dynamic">Energetic / Dynamic</option>
            <option value="Romantic">Romantic</option>
            <option value="Nostalgic">Nostalgic</option>
            <option value="Dark / Gritty">Dark / Gritty</option>
            <option value="Dreamlike / Ethereal">Dreamlike / Ethereal</option>
          </select>
        </div>

        <!-- Lighting -->
        <div>
          <label class="dropdown-label">Lighting</label>
          <select id="lightingSelect" class="w-full rounded-lg bg-white/10 border border-white/15 px-3 py-2 text-white text-sm">
            <option value="">Select lighting...</option>
            <option value="Natural / Soft Light">Natural / Soft Light</option>
            <option value="Golden Hour / Warm Glow">Golden Hour / Warm Glow</option>
            <option value="Blue Hour / Cool Tones">Blue Hour / Cool Tones</option>
            <option value="Dramatic Shadows / High Contrast">Dramatic Shadows / High Contrast</option>
            <option value="Studio Lighting">Studio Lighting</option>
            <option value="Backlit / Rim Light">Backlit / Rim Light</option>
            <option value="Overcast / Diffused Light">Overcast / Diffused Light</option>
            <option value="Harsh Midday Sun">Harsh Midday Sun</option>
            <option value="Candlelight / Low Light">Candlelight / Low Light</option>
            <option value="Neon / Artificial Light">Neon / Artificial Light</option>
          </select>
        </div>

        <!-- Camera -->
        <div>
          <label class="dropdown-label">Camera & Composition</label>
          <select id="cameraSelect" class="w-full rounded-lg bg-white/10 border border-white/15 px-3 py-2 text-white text-sm">
            <option value="">Select camera...</option>
            <option value="Cinematic Framing">Cinematic Framing</option>
            <option value="Wide Angle / Expansive">Wide Angle / Expansive</option>
            <option value="Telephoto / Compressed">Telephoto / Compressed</option>
            <option value="Macro / Close Detail">Macro / Close Detail</option>
            <option value="Aerial / Drone View">Aerial / Drone View</option>
            <option value="Eye-Level / Natural Perspective">Eye-Level / Natural Perspective</option>
            <option value="Low Angle (Looking Up)">Low Angle (Looking Up)</option>
            <option value="High Angle (Looking Down)">High Angle (Looking Down)</option>
            <option value="Rule of Thirds">Rule of Thirds</option>
            <option value="Symmetry / Centered">Symmetry / Centered</option>
          </select>
        </div>

        <!-- Medium -->
        <div>
          <label class="dropdown-label">Medium / Output</label>
          <select id="mediumSelect" class="w-full rounded-lg bg-white/10 border border-white/15 px-3 py-2 text-white text-sm">
            <option value="Photograph / Realistic" selected>Photograph / Realistic</option>
            <option value="Digital Painting">Digital Painting</option>
            <option value="Oil Painting">Oil Painting</option>
            <option value="Watercolor">Watercolor</option>
            <option value="Ink / Sketch">Ink / Sketch</option>
            <option value="Mixed Media">Mixed Media</option>
            <option value="Collage">Collage</option>
            <option value="Sculpture / 3D Model">Sculpture / 3D Model</option>
            <option value="Printmaking Style">Printmaking Style</option>
            <option value="Poster / Graphic Design">Poster / Graphic Design</option>
          </select>
        </div>
      </div>

      <!-- Aspect ratio and Generate button -->
      <div class="grid md:grid-cols-[1fr_auto] gap-4 mb-6">
        <div>
          <label class="dropdown-label">Aspect Ratio</label>
          <select id="ratioSel" class="w-full rounded-lg bg-white/10 border border-white/15 px-3 py-2 text-white">
            <option value="1024x1024">Square (1:1)</option>
            <option value="1536x1024">Horizontal (3:2)</option>
            <option value="1024x1536">Vertical (2:3)</option>
          </select>
        </div>
        
        <div class="flex items-end">
          <button id="genBtn" class="btn px-8">Generate preview</button>
        </div>
      </div>

      <!-- Enhanced Signature Controls -->
      <div class="signature-controls mb-6">
        <div class="signature-control-group">
          <label>Signature</label>
          <input type="text" id="signatureInput" class="rounded bg-white/10 border border-white/15 px-2 py-1 text-sm text-white" 
                 placeholder="Your name..." value="">
        </div>
        
        <div class="signature-control-group">
          <label>Font</label>
          <select id="signatureFont" class="rounded bg-white/10 border border-white/15 px-2 py-1 text-sm text-white">
            <option value="font-elegant">Elegant</option>
            <option value="font-script">Script</option>
            <option value="font-modern">Modern</option>
            <option value="font-classic">Classic</option>
            <option value="font-bold">Bold</option>
          </select>
        </div>
        
        <div class="signature-control-group">
          <label>Color</label>
          <select id="signatureColor" class="rounded bg-white/10 border border-white/15 px-2 py-1 text-sm text-white">
            <option value="white">White</option>
            <option value="black">Black</option>
            <option value="gold">Gold</option>
            <option value="silver">Silver</option>
          </select>
        </div>
        
        <div class="signature-control-group">
          <label>Size</label>
          <input type="range" id="signatureSize" min="12" max="36" value="18" 
                 class="w-24 accent-white">
        </div>
      </div>

      <!-- Preview Section -->
      <div id="previewSection" class="mt-6 hidden">
        <div id="previewWrap" class="preview-container relative w-full max-w-2xl mx-auto rounded-xl overflow-hidden border border-white/10 flex items-center justify-center p-4" style="aspect-ratio:1/1;">
          <img id="previewImg" class="w-full h-full object-contain" alt="Preview" />
          <div class="watermark-overlay">PREVIEW</div>
          <div id="signatureOverlay" class="moveable-signature font-elegant" style="color: white; font-size: 18px; bottom: 20px; right: 20px;">
            <!-- Signature will appear here -->
          </div>
        </div>

        <!-- Controls -->
        <div class="mt-4 flex flex-wrap gap-3 justify-center">
          <button id="selectBtn" class="btn">Select this image</button>
          <button id="shareBtn" class="btn-ghost">Share/Save</button>
          <button id="regenerateBtn" class="btn-ghost">Generate another</button>
          <button id="startOverBtn" class="btn-ghost">Start over</button>
        </div>
        
        <!-- Info text -->
        <p class="text-center text-xs text-gray-500 mt-3">Preview shows the full artwork with watermark. Final print will be produced at selected size.</p>
      </div>

      <!-- Loading state -->
      <div id="loadingState" class="mt-6 hidden">
        <div class="bg-black/40 rounded-xl border border-white/10 p-8 text-center">
          <div class="spinner mx-auto"></div>
          <p class="mt-4 muted">Generating your artwork...</p>
          <p class="mt-2 text-xs text-gray-500">This usually takes 10-15 seconds</p>
        </div>
      </div>

      <!-- Error state -->
      <div id="errorState" class="mt-6 hidden">
        <div class="bg-red-900/20 border border-red-500/30 rounded-xl p-4">
          <p class="text-red-300" id="errorMessage"></p>
        </div>
      </div>
    </div>
  </section>

  <!-- Share Modal (hidden by default) -->
  <div id="shareModal" class="hidden">
    <div class="share-modal-backdrop" onclick="closeShareModal()"></div>
    <div class="share-modal">
      <h3 class="text-xl font-bold mb-4">Share or Save Your Design</h3>
      <p class="text-sm text-gray-400 mb-4">Use this link to return to your design later or share it with others:</p>
      
      <div class="bg-black/40 rounded-lg p-3 mb-4">
        <input type="text" id="shareLink" class="w-full bg-transparent text-white text-sm" readonly>
      </div>
      
      <div class="flex gap-3">
        <button onclick="copyShareLink()" class="btn-ghost flex-1">Copy Link</button>
        <button onclick="emailShareLink()" class="btn-ghost flex-1">Email to Me</button>
        <button onclick="closeShareModal()" class="btn flex-1">Done</button>
      </div>
    </div>
  </div>

  <!-- ORDER -->
  <section id="order" class="max-w-7xl mx-auto px-5 py-14">
    <h2 class="h2 mb-2">Order your print</h2>
    <p id="orderMsg" class="text-sm text-gray-300 mb-6">Generate and select a preview to unlock ordering.</p>

    <!-- Material tabs -->
    <div class="flex gap-2 mb-5">
      <button class="orderTab px-4 py-2 rounded bg-white/10 font-semibold" data-tab="canvas">Canvas</button>
      <button class="orderTab px-4 py-2 rounded border border-white/15" data-tab="metal">Metal</button>
      <button class="orderTab px-4 py-2 rounded border border-white/15" data-tab="acrylic">Acrylic</button>
    </div>

    <!-- Aspect groups -->
    <div class="grid md:grid-cols-3 gap-5">
      <div id="grp-square" class="glass rounded-xl p-4">
        <div class="font-bold mb-3">Square (1:1)</div>
        <div class="opts space-y-1" data-bucket="square">
          <div class="text-xs text-gray-400">Loading products...</div>
        </div>
      </div>
      <div id="grp-h32" class="glass rounded-xl p-4">
        <div class="font-bold mb-3">Horizontal (3:2)</div>
        <div class="opts space-y-1" data-bucket="h32">
          <div class="text-xs text-gray-400">Loading products...</div>
        </div>
      </div>
      <div id="grp-v23" class="glass rounded-xl p-4">
        <div class="font-bold mb-3">Vertical (2:3)</div>
        <div class="opts space-y-1" data-bucket="v23">
          <div class="text-xs text-gray-400">Loading products...</div>
        </div>
      </div>
    </div>

    <div class="mt-6 flex items-center gap-3">
      <div id="selectionSummary" class="text-sm text-gray-300">Selected: —</div>
      <button id="reviewBtn" class="btn disabled">Review & Checkout</button>
    </div>
  </section>

  <!-- FOOTER -->
  <footer class="border-t border-white/10">
    <div class="max-w-7xl mx-auto px-5 py-10 text-sm text-white/70">
      © <span id="y"></span> aiPRINT.ai — All rights reserved.
    </div>
  </footer>

  <!-- APP SCRIPT -->
  <script>
    console.log('🚀 aiPRINT.ai loading...');
    
    const $ = (q, el = document) => el.querySelector(q);
    const $$ = (q, el = document) => [...el.querySelectorAll(q)];
    document.getElementById('y').textContent = new Date().getFullYear();

    // Global state
    let CATALOG = null;
    let currentCollection = 'canvas';
    let currentPreview = null;
    let selected = null;
    let signaturePosition = { x: null, y: null };

    const formatMoney = n => `$${Number(n).toLocaleString()}`;

    const classifyAspect = (w, h) => {
      const r = w / h;
      if (Math.abs(r - 1) <= 0.1) return 'square';
      return r > 1 ? 'h32' : 'v23';
    };

    // Show/hide elements
    const show = el => el?.classList.remove('hidden');
    const hide = el => el?.classList.add('hidden');

    // Build enhanced prompt from dropdowns
    function buildEnhancedPrompt() {
      let prompt = $('#promptInput').value.trim();
      
      // Add style modifiers
      const style = $('#styleSelect').value;
      const mood = $('#moodSelect').value;
      const lighting = $('#lightingSelect').value;
      const camera = $('#cameraSelect').value;
      const medium = $('#mediumSelect').value;
      
      // Build modifiers array
      const modifiers = [];
      if (style) modifiers.push(style);
      if (mood) modifiers.push(mood);
      if (lighting) modifiers.push(lighting);
      if (camera) modifiers.push(camera);
      if (medium) modifiers.push(medium);
      
      // For photo-realistic, add quality modifiers
      if (style === 'Realistic (photo-realistic)') {
        modifiers.push('photorealistic style', 'highly detailed', '8k resolution');
      } else if (style === 'Hyper-realistic') {
        modifiers.push('hyperrealistic style', 'ultra detailed', '8k resolution');
      }
      
      // Combine prompt with modifiers
      if (modifiers.length > 0) {
        prompt = `${prompt}, ${modifiers.join(', ')}`;
      }
      
      return prompt;
    }

    // Enhanced signature functionality
    function initSignatureControls() {
      const signatureOverlay = $('#signatureOverlay');
      let isDragging = false;
      let startX, startY, initialX, initialY;
      
      // Update signature text
      $('#signatureInput').addEventListener('input', (e) => {
        signatureOverlay.textContent = e.target.value;
        signatureOverlay.style.display = e.target.value ? 'block' : 'none';
      });
      
      // Update font
      $('#signatureFont').addEventListener('change', (e) => {
        signatureOverlay.className = `moveable-signature ${e.target.value}`;
      });
      
      // Update color
      $('#signatureColor').addEventListener('change', (e) => {
        const colors = {
          'white': '#FFFFFF',
          'black': '#000000',
          'gold': '#FFD700',
          'silver': '#C0C0C0'
        };
        signatureOverlay.style.color = colors[e.target.value];
      });
      
      // Update size
      $('#signatureSize').addEventListener('input', (e) => {
        signatureOverlay.style.fontSize = `${e.target.value}px`;
      });
      
      // Make signature draggable
      signatureOverlay.addEventListener('mousedown', (e) => {
        isDragging = true;
        const rect = signatureOverlay.getBoundingClientRect();
        const parentRect = $('#previewWrap').getBoundingClientRect();
        
        startX = e.clientX;
        startY = e.clientY;
        initialX = rect.left - parentRect.left;
        initialY = rect.top - parentRect.top;
        
        signatureOverlay.style.cursor = 'grabbing';
      });
      
      document.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        
        const deltaX = e.clientX - startX;
        const deltaY = e.clientY - startY;
        
        signatureOverlay.style.left = `${initialX + deltaX}px`;
        signatureOverlay.style.top = `${initialY + deltaY}px`;
        signatureOverlay.style.right = 'auto';
        signatureOverlay.style.bottom = 'auto';
        
        signaturePosition = {
          x: initialX + deltaX,
          y: initialY + deltaY
        };
      });
      
      document.addEventListener('mouseup', () => {
        isDragging = false;
        signatureOverlay.style.cursor = 'move';
      });
    }

    // Share/Save functionality
    function generateShareLink() {
      if (!currentPreview) return null;
      
      const data = {
        preview: currentPreview,
        prompt: $('#promptInput').value,
        style: $('#styleSelect').value,
        mood: $('#moodSelect').value,
        lighting: $('#lightingSelect').value,
        camera: $('#cameraSelect').value,
        medium: $('#mediumSelect').value,
        signature: {
          text: $('#signatureInput').value,
          font: $('#signatureFont').value,
          color: $('#signatureColor').value,
          size: $('#signatureSize').value,
          position: signaturePosition
        }
      };
      
      const encoded = btoa(JSON.stringify(data));
      return `${window.location.origin}${window.location.pathname}?share=${encoded}`;
    }
    
    function loadFromShareLink() {
      const params = new URLSearchParams(window.location.search);
      const shareData = params.get('share');
      
      if (!shareData) return false;
      
      try {
        const data = JSON.parse(atob(shareData));
        
        // Restore all settings
        $('#promptInput').value = data.prompt;
        $('#styleSelect').value = data.style;
        $('#moodSelect').value = data.mood || '';
        $('#lightingSelect').value = data.lighting || '';
        $('#cameraSelect').value = data.camera || '';
        $('#mediumSelect').value = data.medium;
        
        // Restore signature
        if (data.signature) {
          $('#signatureInput').value = data.signature.text;
          $('#signatureFont').value = data.signature.font;
          $('#signatureColor').value = data.signature.color;
          $('#signatureSize').value = data.signature.size;
          
          if (data.signature.position) {
            signaturePosition = data.signature.position;
            const signatureOverlay = $('#signatureOverlay');
            signatureOverlay.style.left = `${signaturePosition.x}px`;
            signatureOverlay.style.top = `${signaturePosition.y}px`;
            signatureOverlay.style.right = 'auto';
            signatureOverlay.style.bottom = 'auto';
          }
        }
        
        // Restore preview
        if (data.preview) {
          currentPreview = data.preview;
          $('#previewImg').src = data.preview.url;
          setWrapAspect(data.preview.size);
          show($('#previewSection'));
          
          // Apply signature display
          const signatureOverlay = $('#signatureOverlay');
          signatureOverlay.textContent = data.signature?.text || '';
          signatureOverlay.style.display = data.signature?.text ? 'block' : 'none';
        }
        
        return true;
      } catch (e) {
        console.error('Failed to load share data:', e);
        return false;
      }
    }
    
    window.openShareModal = function() {
      const link = generateShareLink();
      if (!link) {
        alert('Please generate a preview first');
        return;
      }
      
      $('#shareLink').value = link;
      show($('#shareModal'));
    };
    
    window.closeShareModal = function() {
      hide($('#shareModal'));
    };
    
    window.copyShareLink = function() {
      $('#shareLink').select();
      document.execCommand('copy');
      alert('Link copied to clipboard!');
    };
    
    window.emailShareLink = function() {
      const link = $('#shareLink').value;
      const subject = 'My aiPRINT.ai Design';
      const body = `Check out my custom artwork design:\n\n${link}`;
      window.location.href = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    };

    // Load product catalog
    async function loadCatalog() {
      console.log('📦 Loading product catalog...');
      
      try {
        const response = await fetch('/products.json');
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const catalog = await response.json();
        console.log('✅ Catalog loaded:', catalog.collections?.length, 'collections');
        
        // Clean the catalog
        catalog.collections?.forEach(c => {
          c.products = c.products?.filter(p =>
            Number.isFinite(p.size_w_in) &&
            Number.isFinite(p.size_h_in) &&
            Number.isFinite(p.price_usd) &&
            p.orientation &&
            p.stripe_payment_link &&
            typeof p.stripe_payment_link === 'string' &&
            p.stripe_payment_link.includes('stripe.com')
          ) || [];
        });
        
        return catalog;
      } catch (error) {
        console.error('❌ Failed to load catalog:', error);
        throw error;
      }
    }

    // Get products for a specific collection and bucket
    function getProductsFor(collectionId, bucket) {
      if (!CATALOG) return [];
      const col = CATALOG.collections?.find(c => c.id === collectionId);
      if (!col) return [];
      
      const orient = bucket === 'square' ? 'square' : (bucket === 'h32' ? 'horizontal' : 'vertical');
      const products = col.products?.filter(p => p.orientation === orient) || [];
      
      // Sort by size
      products.sort((a, b) => {
        const sizeA = Math.max(a.size_w_in, a.size_h_in);
        const sizeB = Math.max(b.size_w_in, b.size_h_in);
        return sizeA - sizeB;
      });
      
      return products;
    }

    // Product rendering
    function renderBucket(bucket) {
      const box = $(`.opts[data-bucket="${bucket}"]`);
      if (!box) return;

      const items = getProductsFor(currentCollection, bucket);
      
      if (!items.length) {
        box.innerHTML = '<div class="opacity-60 text-sm">No sizes available</div>';
        return;
      }

      const materialName = currentCollection.toUpperCase();
      const materialClass = currentCollection === 'canvas' ? 'material-canvas' : 
                           currentCollection === 'metal' ? 'material-metal' : 'material-acrylic';
      
      box.innerHTML = items.map(p => `
        <button class="sizeBtn w-full mb-2 px-3 py-2 rounded bg-white/5 hover:bg-white/10 border border-white/10 text-left text-sm transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled"
                data-material="${currentCollection}"
                data-shape="${bucket}"
                data-lookup="${p.lookup_key}"
                data-label="${materialName} ${p.size_w_in}×${p.size_h_in} — ${formatMoney(p.price_usd)}"
                data-link="${p.stripe_payment_link}">
          <span class="${materialClass} material-badge">${materialName}</span>
          <span class="text-white">${p.size_w_in}×${p.size_h_in}" — ${formatMoney(p.price_usd)}</span>
        </button>
      `).join('');

      // Add click handlers
      box.querySelectorAll('.sizeBtn').forEach(btn => {
        btn.addEventListener('click', () => {
          if (!currentPreview) {
            alert('Please generate and select a preview first.');
            return;
          }
          if (btn.classList.contains('disabled')) return;

          // Update selection
          $$('.sizeBtn').forEach(x => x.classList.remove('ringy', 'bg-white/20'));
          btn.classList.add('ringy', 'bg-white/20');

          selected = {
            material: btn.dataset.material,
            shape: btn.dataset.shape,
            lookup: btn.dataset.lookup,
            label: btn.dataset.label,
            link: btn.dataset.link
          };

          $('#selectionSummary').textContent = `Selected: ${selected.label}`;
          $('#reviewBtn').classList.remove('disabled');
        });
      });
    }

    function renderAllBuckets() {
      ['square', 'h32', 'v23'].forEach(renderBucket);
    }

    function setActiveOnly(bucket) {
      const groups = [['square', '#grp-square'], ['h32', '#grp-h32'], ['v23', '#grp-v23']];
      groups.forEach(([k, sel]) => {
        const el = $(sel);
        if (!el) return;
        
        if (!bucket || k === bucket) {
          el.classList.remove('opacity-30', 'pointer-events-none');
        } else {
          el.classList.add('opacity-30', 'pointer-events-none');
        }
      });
    }

    function setButtonsEnabled(enabledBucket) {
      $$('.sizeBtn').forEach(btn => {
        const shape = btn.dataset.shape;
        const enabled = !!enabledBucket && shape === enabledBucket;
        if (enabled) {
          btn.classList.remove('disabled');
          btn.disabled = false;
        } else {
          btn.classList.add('disabled');
          btn.disabled = true;
        }
      });
    }

    // Generate image
    async function generateImage(prompt, size) {
      console.log('🎨 Generating image:', prompt, size);
      
      try {
        const response = await fetch('/api/generate-image', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt, size })
        });

        if (!response.ok) {
          const error = await response.text();
          throw new Error(`Generation failed: ${error}`);
        }

        const data = await response.json();
        console.log('✅ Image generated:', data);
        
        if (!data.ok || !data.image) {
          throw new Error(data.error || 'No image returned');
        }

        return {
          url: data.image,
          width: data.width || parseInt(size.split('x')[0]),
          height: data.height || parseInt(size.split('x')[1]),
          prompt: prompt,
          size: size
        };
      } catch (error) {
        console.error('❌ Generation error:', error);
        throw error;
      }
    }

    // Set preview aspect ratio
    function setWrapAspect(ratio) {
      const wrap = $('#previewWrap');
      if (!wrap) return;
      
      if (ratio === '1024x1024') wrap.style.aspectRatio = '1 / 1';
      else if (ratio === '1536x1024') wrap.style.aspectRatio = '3 / 2';
      else wrap.style.aspectRatio = '2 / 3';
    }

    // Event handlers
    $('#genBtn').addEventListener('click', async () => {
      const basePrompt = $('#promptInput').value.trim();
      const ratio = $('#ratioSel').value;

      if (!basePrompt) {
        alert('Please enter a prompt');
        return;
      }

      try {
        // Show loading
        hide($('#previewSection'));
        hide($('#errorState'));
        show($('#loadingState'));
        $('#genBtn').disabled = true;
        $('#genBtn').textContent = 'Generating...';

        // Build enhanced prompt
        const enhancedPrompt = buildEnhancedPrompt();
        console.log('Enhanced prompt:', enhancedPrompt);

        const result = await generateImage(enhancedPrompt, ratio);

        currentPreview = {
          url: result.url,
          width: result.width,
          height: result.height,
          prompt: enhancedPrompt,
          size: ratio,
          shape: classifyAspect(result.width, result.height)
        };

        // Update preview
        $('#previewImg').src = result.url;
        setWrapAspect(ratio);
        
        // Handle signature
        const signatureText = $('#signatureInput').value;
        const signatureOverlay = $('#signatureOverlay');
        signatureOverlay.textContent = signatureText;
        signatureOverlay.style.display = signatureText ? 'block' : 'none';
        
        hide($('#loadingState'));
        show($('#previewSection'));
        
        console.log('✅ Preview ready:', currentPreview);

      } catch (error) {
        console.error('❌ Generation failed:', error);
        hide($('#loadingState'));
        $('#errorMessage').textContent = error.message || 'Failed to generate image';
        show($('#errorState'));
      } finally {
        $('#genBtn').disabled = false;
        $('#genBtn').textContent = 'Generate preview';
      }
    });

    $('#selectBtn').addEventListener('click', () => {
      if (!currentPreview) return;

      // Enable ordering for this aspect ratio
      setActiveOnly(currentPreview.shape);
      setButtonsEnabled(currentPreview.shape);
      
      const shapeNames = { square: 'Square', h32: 'Horizontal', v23: 'Vertical' };
      $('#orderMsg').innerHTML = `
        <strong>✓ Image selected!</strong> ${shapeNames[currentPreview.shape]} sizes are now available below.
        Choose your material and size.
      `;
      
      // Scroll to order section
      document.querySelector('#order').scrollIntoView({ behavior: 'smooth' });
      
      console.log('✅ Image selected, ordering unlocked for:', currentPreview.shape);
    });

    $('#shareBtn').addEventListener('click', () => {
      openShareModal();
    });

    $('#regenerateBtn').addEventListener('click', () => {
      $('#genBtn').click();
    });

    $('#startOverBtn').addEventListener('click', () => {
      currentPreview = null;
      hide($('#previewSection'));
      hide($('#errorState'));
      $('#promptInput').value = '';
      $('#ratioSel').selectedIndex = 0;
      
      // Reset dropdowns
      $('#styleSelect').selectedIndex = 0;
      $('#moodSelect').selectedIndex = 0;
      $('#lightingSelect').selectedIndex = 0;
      $('#cameraSelect').selectedIndex = 0;
      $('#mediumSelect').selectedIndex = 0;
      
      // Reset signature
      $('#signatureInput').value = '';
      $('#signatureFont').selectedIndex = 0;
      $('#signatureColor').selectedIndex = 0;
      $('#signatureSize').value = 18;
      signaturePosition = { x: null, y: null };
      
      // Reset ordering
      setActiveOnly(null);
      setButtonsEnabled(null);
      $('#orderMsg').textContent = 'Generate and select a preview to unlock ordering.';
      
      $$('.sizeBtn').forEach(x => {
        x.classList.remove('ringy', 'bg-white/20');
      });
      selected = null;
      $('#selectionSummary').textContent = 'Selected: —';
      $('#reviewBtn').classList.add('disabled');
    });

    // Material tabs
    $$('.orderTab').forEach(btn => {
      btn.addEventListener('click', () => {
        // Update tab styles
        $$('.orderTab').forEach(x => {
          x.classList.remove('bg-white/10', 'font-semibold');
          x.classList.add('border', 'border-white/15');
        });
        btn.classList.add('bg-white/10', 'font-semibold');
        btn.classList.remove('border', 'border-white/15');
        
        // Change current collection
        currentCollection = btn.dataset.tab;
        console.log('📋 Switched to:', currentCollection);
        
        // Re-render all buckets with new material
        renderAllBuckets();
        
        // Re-apply enabled state if preview is selected
        if (currentPreview) {
          setActiveOnly(currentPreview.shape);
          setButtonsEnabled(currentPreview.shape);
        }
        
        // Clear selection when switching materials
        selected = null;
        $('#selectionSummary').textContent = 'Selected: —';
        $('#reviewBtn').classList.add('disabled');
      });
    });

    // Checkout - Direct to Stripe
    $('#reviewBtn').addEventListener('click', () => {
      if (!selected || !currentPreview) {
        alert('Please generate a preview and select a size first.');
        return;
      }

      console.log('🛒 Processing checkout:', selected);
      
      // Go directly to Stripe payment link
      if (selected.link) {
        // Store complete order data including signature settings
        const orderData = {
          preview: currentPreview,
          product: selected,
          signature: {
            text: $('#signatureInput').value,
            font: $('#signatureFont').value,
            color: $('#signatureColor').value,
            size: $('#signatureSize').value,
            position: signaturePosition
          },
          timestamp: Date.now()
        };
        
        sessionStorage.setItem('aiprint_order', JSON.stringify(orderData));
        
        // Redirect to Stripe
        window.location.href = selected.link;
      } else {
        alert('Payment link not available. Please try another product.');
      }
    });

    // Initialize
    (async () => {
      try {
        console.log('🏁 Initializing...');
        
        // Initialize signature controls
        initSignatureControls();
        
        // Load from share link if present
        const loadedFromShare = loadFromShareLink();
        
        // Load catalog
        CATALOG = await loadCatalog();
        renderAllBuckets();
        
        if (!loadedFromShare) {
          setActiveOnly(null);
          setButtonsEnabled(null);
        }
        
        // Show total products
        const totalProducts = CATALOG.collections.reduce((sum, c) => sum + c.products.length, 0);
        console.log(`✅ App ready! ${totalProducts} total products loaded`);
        
      } catch (e) {
        console.error('❌ Failed to initialize:', e);
        $('#orderMsg').textContent = 'Could not load products. Please refresh the page.';
      }
    })();

  </script>
</body>
</html>
