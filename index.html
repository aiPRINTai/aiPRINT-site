<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>aiPRINT.ai — Preview</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Signature fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Allura&family=Dancing+Script:wght@600&family=Playfair+Display:wght@600&family=Montserrat:wght@600&display=swap" rel="stylesheet">

  <style>
    .sig-overlay{position:absolute;left:50%;top:85%;transform:translate(-50%,-50%);pointer-events:auto;user-select:none;white-space:nowrap;text-shadow:0 1px 2px rgba(0,0,0,.25)}
    .sig-editing{outline:1px dashed rgba(255,255,255,.5);outline-offset:2px}
    .sig-gv{font-family:'Great Vibes',cursive}
    .sig-all{font-family:'Allura',cursive}
    .sig-ds{font-family:'Dancing Script',cursive}
    .sig-pf{font-family:'Playfair Display',serif}
    .sig-ms{font-family:'Montserrat',sans-serif}
  </style>
</head>
<body class="bg-neutral-900 text-white">
  <main class="max-w-5xl mx-auto px-4 py-8">
    <h1 class="text-2xl font-semibold mb-6">Create a preview</h1>

    <!-- Prompt + options -->
    <div class="grid md:grid-cols-3 gap-4">
      <label class="md:col-span-2 flex flex-col">
        <span class="text-white/70 mb-1">Describe what you want</span>
        <textarea id="prompt" rows="4" class="rounded-lg bg-white/10 border border-white/15 px-3 py-2 text-white" placeholder="e.g., sunset over the ocean in watercolor style"></textarea>
      </label>

      <div class="space-y-3">
        <label class="flex flex-col">
          <span class="text-white/70 mb-1">Aspect ratio</span>
          <select id="ratio" class="rounded-lg bg-white/10 border border-white/15 px-3 py-2 text-white">
            <option value="square">Square (1:1)</option>
            <option value="horizontal">Horizontal (3:2)</option>
            <option value="vertical">Vertical (2:3)</option>
          </select>
        </label>

        <button id="btn-generate" class="w-full rounded-lg bg-white text-black font-semibold py-2 hover:opacity-90">
          Generate preview
        </button>
      </div>
    </div>

    <!-- Preview -->
    <div id="preview-wrap" class="relative mt-6 rounded-lg overflow-hidden border border-white/15 bg-black/30 min-h-[320px] flex items-center justify-center">
      <img id="preview" class="max-h-[70vh] w-auto object-contain" alt="Preview" />
      <div id="sig" class="sig-overlay hidden"></div>
    </div>

    <!-- Signature controls -->
    <div class="mt-4 rounded-lg border border-white/15 p-4 bg-white/5">
      <div class="flex items-center justify-between">
        <div class="font-semibold">Artist Signature (optional)</div>
        <label class="inline-flex items-center gap-2 select-none">
          <input id="sig-enable" type="checkbox" class="h-4 w-4">
          <span class="text-white/80 text-sm">Show on preview</span>
        </label>
      </div>

      <div id="sig-controls" class="grid md:grid-cols-4 gap-3 mt-3 opacity-50 pointer-events-none">
        <label class="flex flex-col">
          <span class="text-white/70 mb-1">Name</span>
          <input id="sig-text" type="text" class="rounded-lg bg-white/10 border border-white/15 px-3 py-2 text-white" placeholder="Type your name…" />
        </label>

        <label class="flex flex-col">
          <span class="text-white/70 mb-1">Font</span>
          <select id="sig-font" class="rounded-lg bg-white/10 border border-white/15 px-3 py-2 text-white">
            <option value="sig-gv">Great Vibes (cursive)</option>
            <option value="sig-all">Allura (cursive)</option>
            <option value="sig-ds">Dancing Script (cursive, bold)</option>
            <option value="sig-pf">Playfair Display (serif)</option>
            <option value="sig-ms">Montserrat (sans)</option>
          </select>
        </label>

        <label class="flex flex-col">
          <span class="text-white/70 mb-1">Color</span>
          <input id="sig-color" type="color" value="#ffffff" class="h-10 rounded bg-white/10 border border-white/15" />
        </label>

        <label class="flex flex-col">
          <span class="text-white/70 mb-1">Size</span>
          <input id="sig-size" type="range" min="18" max="72" value="36">
        </label>

        <p class="md:col-span-4 text-white/60 text-sm">
          Tip: drag your signature on the preview to place it.
        </p>
      </div>
    </div>

    <!-- Actions -->
    <div id="gen-actions" class="hidden mt-4 flex flex-wrap items-center gap-3">
      <input id="gen-url" class="w-full md:w-auto flex-1 rounded-lg bg-white/10 border border-white/15 px-3 py-2 text-white/80" readonly />
      <button id="copy-link" class="rounded-md bg-white text-black font-semibold px-4 py-2 hover:opacity-90">Copy link</button>
      <a id="download-link" href="#" download="aiPRINT-preview.png" class="rounded-md bg-white/10 border border-white/15 px-4 py-2 font-semibold">Download</a>
      <button id="toggle-prompt" class="rounded-md bg-white/10 border border-white/15 px-4 py-2">Show prompt</button>
    </div>

    <div id="prompt-wrap" class="hidden mt-3 rounded-lg border border-white/15 p-3 bg-white/5">
      <div class="text-sm text-white/60 mb-1">Prompt used:</div>
      <div id="prompt-text" class="text-white"></div>
    </div>

    <!-- ORDER PANEL -->
    <div id="order-panel" class="mt-8 hidden">
      <h3 class="text-xl font-semibold text-white mb-3">Order your print</h3>
      <div class="grid gap-3 md:grid-cols-3">
        <label class="flex flex-col">
          <span class="text-white/70 mb-1">Material</span>
          <select id="sel-material" class="rounded-md bg-white/10 border border-white/15 px-3 py-2 text-white">
            <option value="canvas">Signature Series — Fine Art Canvas</option>
            <option value="metal">Gallery Edition — ChromaLuxe Metal</option>
            <option value="acrylic">Museum Collection — Acrylic Facemount</option>
          </select>
        </label>
        <label class="flex flex-col">
          <span class="text-white/70 mb-1">Orientation</span>
          <select id="sel-orientation" class="rounded-md bg-white/10 border border-white/15 px-3 py-2 text-white">
            <option value="square">Square</option>
            <option value="horizontal">Horizontal</option>
            <option value="vertical">Vertical</option>
          </select>
        </label>
        <label class="flex flex-col">
          <span class="text-white/70 mb-1">Size</span>
          <select id="sel-size" class="rounded-md bg-white/10 border border-white/15 px-3 py-2 text-white"></select>
        </label>
      </div>
      <div class="mt-4 flex items-center gap-3">
        <a id="btn-checkout" href="#" class="inline-flex items-center rounded-md bg-white text-black font-semibold px-4 py-2 hover:opacity-90 transition">Checkout</a>
        <span id="order-note" class="text-white/60 text-sm">All prints are ready to hang.</span>
      </div>
    </div>
  </main>

  <script>
  const $ = s => document.querySelector(s);
  const previewImg = $('#preview');
  const genUrlEl = $('#gen-url');
  const downloadEl = $('#download-link');
  const actionsEl = $('#gen-actions');

  const promptEl = $('#prompt');
  const ratioEl = $('#ratio');
  const btnGen = $('#btn-generate');

  const togglePrompt = $('#toggle-prompt');
  const promptWrap = $('#prompt-wrap');
  const promptTextEl = $('#prompt-text');

  // Signature elements
  const sigEnable = $('#sig-enable');
  const sigControls = $('#sig-controls');
  const sigEl = $('#sig');
  const sigText = $('#sig-text');
  const sigFont = $('#sig-font');
  const sigColor = $('#sig-color');
  const sigSize = $('#sig-size');

  // Order elements
  const elOrderPanel = $('#order-panel');
  const elMaterial = $('#sel-material');
  const elOrient = $('#sel-orientation');
  const elSize = $('#sel-size');
  const elCheckout = $('#btn-checkout');
  const elNote = $('#order-note');

  // ---------- Your Stripe Payment Links ----------
  const PAYMENT_LINKS = {
    canvas: {
      square: {
        "24×24": "https://buy.stripe.com/test_6oU00jdsm2D32Dr2dvcV20o",
        "30×30": "https://buy.stripe.com/test_4gM9AT2NI4Lb4Lzf0hcV20p"
      },
      horizontal: {
        "24×16": "https://buy.stripe.com/test_dRmeVdfAua5va5T6tLcV20q",
        "30×20": "https://buy.stripe.com/test_dRmaEXbkeelLfqdbO5cV20r"
      },
      vertical: {
        "16×24": "https://buy.stripe.com/test_fZu3cvdsmfpP7XL9FXcV20s",
        "20×30": "https://buy.stripe.com/test_5kQ28raga7Xn7XLbO5cV20t"
      }
    },
    metal: {
      square: {
        "24×24": "https://buy.stripe.com/test_14A5kDewqgtT0vj9FXcV20u",
        "30×30": "https://buy.stripe.com/test_dRm4gzagab9z4Lz3hzcV20v"
      },
      horizontal: {
        "24×16": "https://buy.stripe.com/test_cNi4gz0FA3H7guh6tLcV20D",
        "30×20": "https://buy.stripe.com/test_fZufZhbke2D31znaK1cV20C"
      },
      vertical: {
        "16×24": "https://buy.stripe.com/test_14A28r9c61yZ2DraK1cV20G",
        "20×30": "https://buy.stripe.com/test_3cI5kDagagtT0vj4lDcV20H"
      }
    },
    acrylic: {
      square: {
        "24×24": "https://buy.stripe.com/test_5kQ28raga91r5PD8BTcV20B",
        "30×30": "https://buy.stripe.com/test_aFa6oHaga6Tjdi54lDcV20A"
      },
      horizontal: {
        "24×16": "https://buy.stripe.com/test_bJe14ndsma5v3Hv5pHcV20z",
        "30×20": "https://buy.stripe.com/test_9B628r9c6dhH3Hvg4lcV20y"
      },
      vertical: {
        "16×24": "https://buy.stripe.com/test_cNi28rfAu91rb9X9FXcV20x",
        "20×30": "https://buy.stripe.com/test_eVqbJ1coi5PfguhaK1cV20w"
      }
    }
  };

  // ---------- Generation ----------
  function mapRatioToSize(r) {
    if (r === 'horizontal') return '1536x1024';
    if (r === 'vertical')   return '1024x1536';
    return '1024x1024';
  }

  btnGen.addEventListener('click', async () => {
    const base = (promptEl.value || '').trim();
    if (!base) { alert('Please add a description.'); return; }

    const ratio = ratioEl.value;
    const size = mapRatioToSize(ratio);
    const prompt = base;

    btnGen.disabled = true;
    btnGen.textContent = 'Generating…';

    try {
      const r = await fetch('/api/generate-image', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt, size })
      });
      const data = await r.json();
      if (!r.ok || !data?.ok) throw new Error(data?.error || 'Failed');

      previewImg.src = data.image;
      previewImg.onload = () => {
        genUrlEl.value = data.image;
        actionsEl.classList.remove('hidden');
        downloadEl.href = data.image;

        showOrderPanel(ratio);
        promptTextEl.textContent = prompt;
      };
    } catch (err) {
      alert(err.message || 'Something went wrong.');
    } finally {
      btnGen.disabled = false;
      btnGen.textContent = 'Generate preview';
    }
  });

  $('#copy-link').addEventListener('click', async () => {
    try { await navigator.clipboard.writeText(genUrlEl.value || ''); alert('Link copied'); } catch {}
  });

  togglePrompt.addEventListener('click', () => {
    const hidden = promptWrap.classList.contains('hidden');
    promptWrap.classList.toggle('hidden', !hidden);
    togglePrompt.textContent = hidden ? 'Hide prompt' : 'Show prompt';
  });

  // ---------- Signature ----------
  function enableSigUI(enabled){
    sigControls.style.opacity = enabled ? '1' : '.5';
    sigControls.style.pointerEvents = enabled ? 'auto' : 'none';
    sigEl.classList.toggle('hidden', !enabled);
    sigEl.classList.toggle('sig-editing', enabled);
  }
  function updateSignature(){
    sigEl.textContent = sigText.value || '';
    sigEl.className = `sig-overlay ${sigFont.value}`;
    sigEl.style.color = sigColor.value;
    sigEl.style.fontSize = `${sigSize.value}px`;
  }
  sigEnable.addEventListener('change', () => { enableSigUI(sigEnable.checked); if(sigEnable.checked) updateSignature(); });
  [sigText, sigFont, sigColor, sigSize].forEach(el => el.addEventListener('input', updateSignature));

  (function makeDraggable(el){
    let dragging=false,startX=0,startY=0,startLeft=0,startTop=0;
    const pos = e => (e.touches&&e.touches[0]) ? {x:e.touches[0].clientX,y:e.touches[0].clientY} : {x:e.clientX,y:e.clientY};
    function down(e){ if(el.classList.contains('hidden'))return; dragging=true; el.classList.add('sig-editing');
      const p=pos(e); startX=p.x; startY=p.y; const r=el.getBoundingClientRect(); startLeft=r.left; startTop=r.top; e.preventDefault(); }
    function move(e){ if(!dragging)return; const p=pos(e); const dx=p.x-startX, dy=p.y-startY;
      const wrap=$('#preview-wrap').getBoundingClientRect();
      const nx=startLeft+dx-wrap.left, ny=startTop+dy-wrap.top;
      el.style.left = `${nx}px`; el.style.top = `${ny}px`; el.style.transform='translate(0,0)'; }
    function up(){ dragging=false; }
    el.addEventListener('mousedown',down); window.addEventListener('mousemove',move); window.addEventListener('mouseup',up);
    el.addEventListener('touchstart',down,{passive:false}); window.addEventListener('touchmove',move,{passive:false}); window.addEventListener('touchend',up);
  })(sigEl);

  // ---------- Order / Stripe ----------
  function repopulateSizes(){
    const material = elMaterial.value, orient = elOrient.value;
    const map = PAYMENT_LINKS[material]?.[orient] || {};
    elSize.innerHTML = '';
    const sizes = Object.keys(map);
    if(!sizes.length){
      elSize.disabled = true; elCheckout.classList.add('opacity-60','pointer-events-none'); elCheckout.href='#';
      elNote.textContent = 'This combo isn’t available yet.';
      const opt=document.createElement('option'); opt.value=''; opt.textContent='Not available'; elSize.appendChild(opt);
      return;
    }
    elSize.disabled=false; elCheckout.classList.remove('opacity-60','pointer-events-none'); elNote.textContent='All prints are ready to hang.';
    sizes.forEach(s => { const o=document.createElement('option'); o.value=s; o.textContent=s; elSize.appendChild(o); });
  }
  function updateCheckoutLink(){
    const url = PAYMENT_LINKS[elMaterial.value]?.[elOrient.value]?.[elSize.value] || '#';
    elCheckout.href = url; elCheckout.target = url.startsWith('http') ? '_blank' : '_self';
  }
  [elMaterial, elOrient].forEach(el => el.addEventListener('change', () => { repopulateSizes(); updateCheckoutLink(); }));
  elSize.addEventListener('change', updateCheckoutLink);

  function showOrderPanel(preferredOrientation){
    if (preferredOrientation) elOrient.value = preferredOrientation;
    elOrderPanel.classList.remove('hidden'); repopulateSizes(); updateCheckoutLink();
  }
  </script>
</body>
</html>
